!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=12)}([function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{log:!1},t=window.console.info,n=window.console.log,r=window.console.warn;return window.console.info=function(){if(e.log===!0||"INFO"===e.log)return t.apply(void 0,arguments)},window.console.log=function(){if(e.log===!0||"LOG"===e.log)return n.apply(void 0,arguments)},window.console.warn=function(){if(e.log===!0||"WARN"===e.log)return r.apply(void 0,arguments)},(0,a.default)(p)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=o;var i=n(7),a=r(i),s=n(10),u=r(s),l=n(8),c=r(l),d=n(11),f=r(d),p={toHtml:f.default,providers:{mal:(0,u.default)()},storage:localStorage,bus:(0,c.default)()}},function(e,t,n){"use strict";function r(e,t,n,r){var o=e.bus,i=e.storage,a={},s=function(e,t){a[e]||(a[e]={}),clearTimeout(a[e].timeout),a[e].timeout=setTimeout(t,200)};o.when("card:changed",function(e){}),o.when("anime:currentEpisodeChanged",function(e){console.info("Episode count changed:",e),s("updateEpisodeCount",function(){o.emit("app:isDoingSomeWork");var a=JSON.stringify(r);i.setItem("app."+n.username+".list",a),t.updateEpisodeCount(e.id,e.currentEpisode).then(function(e){o.emit("app:isDoneDoingSomeWork")})})})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r},function(e,t,n){"use strict";function r(e,t,n){var r=e.toHtml,o=e.bus,i=void 0,a={},s=function(e){return new Proxy(e,{set:function(e,t,n){var r=e[t];e[t]=n;var i=Object.assign({},e);return o.emit("card:changed",{state:i,oldValue:r,newValue:n}),!0}})},u=function(e){var t='\n      <div class="card card--showTitleOnHover isStatus-'+e.status+'" data-id="'+e.id+'">\n        <div class="card__title">\n          <p data-ref="title">'+e.title+'</p>\n        </div>\n        <figure class="card__image-container">\n          <a href="https://myanimelist.net/anime/'+e.id+'" target="_blank" class="card__link">\n            <img data-ref="image" src="'+e.image+'" alt="'+e.title+'">\n          </a>\n        </figure>\n        <div class="card__controls">\n          <button class="card__episode-button" data-ref="decrement">-</button>\n          <div class="card__episode-count">\n            <div>\n              <input type="number" data-ref="input" class="episode-count__input" value="'+e.currentEpisode+'">\n              <span class="episode-count__title">Episodes seen:</span>\n              <span class="episode-count__episodes"><span data-ref="currentEpisode">'+e.currentEpisode+'</span>/<span data-ref="episodeCount">'+(e.episodeCount?e.episodeCount:"??")+'</span></span>\n            </div>\n          </div>\n          <button class="card__episode-button" data-ref="increment">+</button>\n        </div>\n      </div>';return r(t)},l=function(){m.currentEpisode!==n.episodeCount&&(m.currentEpisode=m.currentEpisode+1,f(),o.emit("anime:currentEpisodeChanged",{id:m.id,currentEpisode:m.currentEpisode}))},c=function(){0!==m.currentEpisode&&(m.currentEpisode=m.currentEpisode-1,f(),o.emit("anime:currentEpisodeChanged",{id:m.id,currentEpisode:m.currentEpisode}))},d=function(e){m.currentEpisode=parseInt(e.target.value),f(),o.emit("anime:currentEpisodeChanged",{id:m.id,currentEpisode:m.currentEpisode})},f=function(){a.input.value=m.currentEpisode,a.currentEpisode.textContent=m.currentEpisode,a.episodeCount.textContent=n.episodeCount?n.episodeCount:"??",a.image.src=m.image,a.image.alt=m.title,a.title.textContent=m.title},p=function(){t.firstElementChild&&t.firstElementChild.remove(),i=u(m),a.currentEpisode=i.querySelector('[data-ref="currentEpisode"]'),a.episodeCount=i.querySelector('[data-ref="episodeCount"]'),a.input=i.querySelector('[data-ref="input"]'),a.image=i.querySelector('[data-ref="image"]'),a.title=i.querySelector('[data-ref="title"]'),i.querySelector('[data-ref="increment"]').addEventListener("click",l),i.querySelector('[data-ref="decrement"]').addEventListener("click",c),a.input.addEventListener("change",d),t.appendChild(i)},m=s(n),v=function(e){Object.assign(m,e)};return o.when("anime:changed",{id:n.id},function(e){v(e),f()}),{state:m,updateCard:f,render:p}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r},function(e,t,n){"use strict";function r(e,t,n,r){var o=null,i=r.slice(),a=[],s=i,u=32,l=0,c=window.innerHeight,d={status:"watching",season:"all",year:"all"},f={winter:0,spring:3,summer:6,fall:9},p=function(e){var t=Object.keys(f),n=0;console.log(e);for(var r in f){if(e>=f[r]&&e<f[t[n+1]])return r;n++}return!1},m=function(e){return 1===e.status},v=function(e){return 2===e.status},h=function(e){return 3===e.status},g=function(e){return 4===e.status},w=function(e){return 6===e.status},y=function(e){return new Date(e.starts).getMonth()==f.winter},_=function(e){return new Date(e.starts).getMonth()==f.spring},E=function(e){return new Date(e.starts).getMonth()==f.summer},b=function(e){return new Date(e.starts).getMonth()==f.fall},S=function(e){if(!(a.length>=s.length)){var t=l-(window.scrollY+c);t<l/2&&O()}};window.addEventListener("scroll",S,{passive:!0}),window.addEventListener("resize",function(){c=window.innerHeight},{passive:!0});var L=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"watching",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"all";d.status=e,d.season=t,d.year=n;var r=N(i),o=k(r);s=o},k=function(e){var t=e.slice();switch(d.status){case"watching":t=t.filter(m);break;case"completed":t=t.filter(v);break;case"onhold":t=t.filter(h);break;case"dropped":t=t.filter(g);break;case"plantowatch":t=t.filter(w);break;case"all":t=t;break;default:throw new Error('Unrecognized filter "'+status+'"')}switch(d.season){case"winter":t=t.filter(y);break;case"spring":t=t.filter(_);break;case"summer":t=t.filter(E);break;case"fall":t=t.filter(b);break;case"all":t=t;break;default:throw new Error('Unrecognized filter "'+season+'"')}return"all"!==d.year&&(d.year=parseInt(d.year,10),t=t.filter(function(e){return new Date(e.starts).getFullYear()===d.year})),t},N=function(e){var t=e.slice().sort(function(e,t){return e.status>t.status?1:e.status<t.status?-1:e.status===t.status?0:void 0}),n={};t.forEach(function(e){n[e.status]||(n[e.status]=[]),n[e.status].push(e)});var r=[];for(var o in n)n[o].sort(function(e,t){var n=new Date(e.starts),r=new Date(t.starts);return n.getTime()<r.getTime()?1:-1}),r=r.concat(n[o]);return r},C=function(){if(a.length&&a.forEach(function(e){var t=e.node;return t.remove()}),a=[],!s.length)return o.classList.add("isEmpty"),void console.warn("! nothing found... show empty state!");o.classList.remove("isEmpty");var e=x();P(e),M()},O=function(){if(a.length>=s.length)return void console.info("Completely rendered state to DOM.");var e=x();P(e),M()},P=function(n){n.forEach(function(n){var r=document.createElement("li"),o=t(e,r,n);o.render(),a.push({instance:o,id:o.state.id,node:r})}),a.forEach(function(e){var t=e.node;return o.appendChild(t)})},x=function(){var e=a.length,t=s.slice(e,e+u);return t},M=function(){l=o.offsetTop+o.offsetHeight},q=function(e){console.info("updateState: Updating to new state."),i=e.slice();var t=N(i),n=k(t);s=n},D=function(){if(o)throw new Error("register(): rootNode already set, cannot register component");o=document.querySelector(n);var e="watching",t="all",r="all";L(e,t,r);var i=document.querySelectorAll("[data-filter-status]"),a=document.querySelector('[data-filter-season="current"]'),s=document.querySelector('[data-filter-season="all"]'),u=new Date,l=p(u.getMonth()),c=u.getFullYear();a.setAttribute("data-season",l),a.setAttribute("data-year",c),a.textContent=l.charAt(0).toUpperCase()+l.slice(1)+" "+c,document.querySelector('[data-filter-status="'+e+'"]').classList.add("active"),s.classList.add("active");var d=function(n){s.classList.remove("active"),n.target.classList.add("active"),t=l,r=c,L(e,t,r),C()},f=function(n){a.classList.remove("active"),n.target.classList.add("active"),t="all",r="all",L(e,t,r),C()},m=function(n){e=n.target.getAttribute("data-filter-status"),i.forEach(function(e){return e.classList.remove("active")}),n.target.classList.add("active"),L(e,t,r),C()};i.forEach(function(e){return e.addEventListener("click",m)}),a.addEventListener("click",d),s.addEventListener("click",f),C()};return{register:D,filter:L,state:s,updateState:q,render:C,renderNextStatePartial:O}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r},function(e,t,n){"use strict";function r(e,t){var n=e.bus,r=null,o=0,i=!0,a=function(){console.info("loader:show() show a loader"),i=!0,o++,r.classList.add("isLoading")},s=function(){i&&(--o||(console.info("loader:hide() all loaders done"),r.classList.remove("isLoading"),i=!1))},u=function(){if(r)throw new Error("register(): rootNode already set, cannot register component");r=document.querySelector(t),n.when("app:isDoingSomeWork",a),n.when("app:isDoneDoingSomeWork",s)};return{show:a,hide:s,register:u}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r},function(e,t,n){"use strict";function r(e,t,n){var r=e.storage,o=e.bus,i=null,a=null,s=null,u=null,l=null,c=function(){r.removeItem("app.user");window.location.reload()},d=function(){var e=r.getItem("app.user");return new Promise(function(n,r){if(l=n,!e)return void f();var o=JSON.parse(e);t.setCredentials(o.username,o.password),l(o)})},f=function(){document.body.classList.add("hasOverlay"),i.classList.add("isShown")},p=function(){document.body.classList.remove("hasOverlay"),i.classList.remove("isShown")},m=function(e){e.preventDefault(),h();var n=new FormData(e.target),a=n.get("username"),s=n.get("password");return a.trim()&&s.trim()?(i.classList.add("isLoading"),void t.authenticate(a,s).then(function(e){i.classList.remove("isLoading"),e.user?(console.info('Successfully logged in user "'+a+'"'),p(),r.setItem("app.user",JSON.stringify({username:a,password:s})),l&&l({username:a,password:s}),o.emit("app:userLoggedIn",{username:a,password:s})):v()}).catch(function(e){i.classList.remove("isLoading"),v()})):void v()},v=function(){s.classList.add("isShown")},h=function(){s.classList.remove("isShown")},g=function(e){e.preventDefault(),c()},w=function(){if(i)throw new Error("register(): rootNode already set, cannot register component");i=document.querySelector(n),s=i.querySelector('[data-ref="error"]'),a=i.querySelector("form"),u=document.querySelector('[data-ref="logout"]'),a.addEventListener("submit",m),u.addEventListener("click",g)};return{register:w,showLoginPrompt:f,hideLoginPrompt:p,loginOrPrompt:d}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r},function(e,t,n){"use strict";function r(e,t){var n=(e.bus,null),r=null,o=null,i=null,a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new Promise(function(u){i=u,r.textContent=e,o.childNodes.length&&o.childNodes.forEach(function(e){return e.remove()}),t.forEach(function(e){var t=document.createElement("button");t.textContent=e,o.appendChild(t);var n=function n(){i(e),i=null,t.removeEventListener("click",n),s()};t.addEventListener("click",n)}),a&&setTimeout(s,a===!0?2e3:a),n.classList.add("isShown")})},s=function(){n.classList.remove("isShown"),i&&(i(null),i=null)},u=function(){if(n)throw new Error("register(): rootNode already set, cannot register component");n=document.querySelector(t),r=n.querySelector("p"),o=n.querySelector(".toast__controls")};return{register:u,show:a}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(e){console.info("initialize with ",e);var t=e.providers.mal;console.info("initialize app...");var n=(0,m.default)(e,t,'[data-ref="login"]');n.register(),n.loginOrPrompt().then(function(n){var r=[],o=e.storage.getItem("app."+n.username+".list");o&&(console.info("Using cached list..."),r=JSON.parse(o)),(0,a.default)(e,t,n,r),console.log("Registering components...");var i=(0,h.default)(e,'[data-ref="toast"]'),s=(0,f.default)(e,'[data-ref="loader"]'),l=(0,c.default)(e,u.default,'[data-ref="cardContainer"]',r);s.register(),l.register(),i.register(),e.bus.emit("app:isDoingSomeWork"),t.list.get().then(function(t){console.info("Fetched list from provider."),e.bus.emit("app:isDoneDoingSomeWork");var r=JSON.stringify(t);o?o!==r?(console.info("List updated, resetting cache with new list"),e.storage.setItem("app."+n.username+".list",r),l.updateState(t),l.render(),i.show("Your list on MAL was updated, changes are reflected here.",[],3e3)):console.info("List the same, using cached list"):(console.info("Updating list from empty cache"),e.storage.setItem("app."+n.username+".list",r),l.updateState(t),l.render())}).catch(function(t){e.bus.emit("app:isDoneDoingSomeWork"),i.show("Failed to retrieve list from MAL. See console for errors",[],3e3),console.error(t)})})}Object.defineProperty(t,"__esModule",{value:!0}),t.default=o;var i=n(1),a=r(i),s=n(2),u=r(s),l=n(3),c=r(l),d=n(4),f=r(d),p=n(5),m=r(p),v=n(6),h=r(v)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){var e={},t=function(e,t){var n=Object.keys(t),r=!0,o=!1,i=void 0;try{for(var a,s=n[Symbol.iterator]();!(r=(a=s.next()).done);r=!0){var u=a.value;if(t[u]!==e[u]||!(u in e))return!1}}catch(e){o=!0,i=e}finally{try{!r&&s.return&&s.return()}finally{if(o)throw i}}return!0};return{when:function(t){e[t]||(e[t]=[]);for(var n=void 0,r=void 0,o=arguments.length,i=Array(o>1?o-1:0),a=1;a<o;a++)i[a-1]=arguments[a];return 1===i.length&&(n=i[0],r=null),2===i.length&&(r=i[0],n=i[1]),e[t].push({filter:r,handler:n}),this},emit:function(n){for(var r=arguments.length,o=Array(r>1?r-1:0),i=1;i<r;i++)o[i-1]=arguments[i];if(!e[n]){var a;return void(a=console).warn.apply(a,['Emit: No handlers for event: "'+n+'", args: '].concat(o))}var s=void 0,u=void 0;return 1===o.length&&(s=o[0],u=null),2===o.length&&(u=o[0],s=o[1]),console.info('Emitting event: "'+n+'" with payload:',s," and filter: ",u),e[n].forEach(function(e){var n=e.handler,r=e.filter;return!u&&r?void console.warn('Trying to emit an even on a channel that has a filter, requires filter: "'+JSON.stringify(r)+'"'):!u||r&&t(u,r)?void n(s):void 0}),this},delete:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e[t])return console.warn('Delete: No handlers for channel "'+t+'"'),!1;if(!n)return delete e[t],this;var r=e[t].findIndex(function(e){var t=e.handler;return t===n});return r!==-1&&(e[t].splice(r,1),this)}}};t.default=r},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(){function e(t,n){var o=this;if(r(this,e),!t||!n)throw new Error("MALjs requires a myanimelist.net username and password.");this._user=t,this._password=n,this._base="https://myanimelist.net",this._parser=new DOMParser,this.anime={search:function(e){return o.search(e,"anime")},list:function(){return o.list("anime")},add:function(e,t){return o.add(e,t,"anime")},update:function(e,t){return o.update(e,t,"anime")},delete:function(e,t){return o.delete(e,"anime")}},this.manga={search:function(e){return o.search(e,"manga")},list:function(){return o.list("manga")},add:function(e,t){return o.add(e,t,"manga")},update:function(e,t){return o.update(e,t,"manga")},delete:function(e,t){return o.delete(e,"manga")}}}return o(e,[{key:"search",value:function(e,t){return this._checkType(t),this._get(this._base+"/api/"+t+"/search.xml?q="+e)}},{key:"list",value:function(e){return this._checkType(e),this._get(this._base+"/malappinfo.php?u="+this._user+"&status=all&type="+e)}},{key:"add",value:function(e,t,n){if(this._checkType(n),t)return t.entry||(t={entry:t}),this._post(this._base+"/api/"+n+"list/add/"+e+".xml",t)}},{key:"update",value:function(e,t,n){if(this._checkType(n),t)return t.entry||(t={entry:t}),this._post(this._base+"/api/"+n+"list/update/"+e+".xml",t)}},{key:"delete",value:function(e,t){return this._checkType(t),this._post(this._base+"/api/"+t+"list/delete/"+e+".xml")}},{key:"verifyCredentials",value:function(){return this._get(this._base+"/api/account/verify_credentials.xml")}},{key:"_checkType",value:function(e){if("anime"!==e&&"manga"!==e)throw new Error("Only allowed types are anime and manga. incorrect type: "+e+" given.")}},{key:"_xmlToJson",value:function(e){var t=this;return new Promise(function(n,r){var o=t._parser.parseFromString(e,"text/xml");"html"===o.documentElement.nodeName?r("Failed to parse xml."):n(t._domToJson(o))})}},{key:"_domToJson",value:function(e){for(var t=e.childNodes,n={},r=0;r<t.length;r++){var o=t[r];"myanimelist"===o.nodeName?n[o.nodeName]={}:n[o.nodeName]=[];for(var i=o.childNodes,a=0;a<i.length;a++){var s=i[a],u={};if("#text"!==s.nodeName){for(var l=s.childNodes,c=0;c<l.length;c++){var d=l[c];if("#text"!==d.nodeName){var f=d.innerHTML;"id"!==d.nodeName&&"episodes"!==d.nodeName||(f=parseInt(f,10)),u[d.nodeName]=f}}"myanimelist"===o.nodeName?"anime"===s.nodeName||"manga"===s.nodeName?(n[o.nodeName][s.nodeName]||(n[o.nodeName][s.nodeName]=[]),n[o.nodeName][s.nodeName].push(u)):n[o.nodeName][s.nodeName]=u:n[o.nodeName].push(u)}}}return n}},{key:"_toXml",value:function(e){function t(e){for(var r in e)e.hasOwnProperty(r)&&(e[r].constructor==Object?(n+="<"+r+">",t(e[r]),n+="</"+r+">"):n+="<"+r+">"+e[r]+"</"+r+">")}var n='<?xml version="1.0" encoding="UTF-8" standalone="yes"?>';return t(e),n}},{key:"_get",value:function(e){var t=this;return new Promise(function(n,r){t._getForBrowser(e,n,r)})}},{key:"_getForBrowser",value:function(e,t,n){var r=this,o=new XMLHttpRequest;o.open("GET",e,!0,this._user,this._password),o.onload=function(){if(200===o.status){var i=o.response;r._xmlToJson(i).then(t).catch(n)}else n('Request failed: called url "'+e+'", with user "'+r._user+'" and password "'+r._password+'"')},o.onerror=function(){n('Request failed: called url "'+e+'", with user "'+r._user+'" and password "'+r._password+'"')},o.send()}},{key:"_post",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise(function(r,o){t._postForBrowser(e,n,r,o)})}},{key:"_postForBrowser",value:function(e,t,n,r){var o=new XMLHttpRequest;if(o.open("POST",e,!0,this._user,this._password),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onload=function(){200===o.status||201===o.status?n(o.response):r(o.response)},o.onerror=function(){r('Request failed: Called url "'+e+'", with user "'+this._user+'" and password "'+this._password+'". Data passed: "'+JSON.stringify(t,null,2)+'"')},t){var i=this._toXml(t);o.send("data="+i)}else o.send()}}]),e}();t.default=i},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(){var e=void 0;return{setCredentials:function(t,n){e=new a.default(t,n)},authenticate:function(t,n){return e=new a.default(t,n),e.verifyCredentials()},updateEpisodeCount:function(t,n){return t&&n?e.anime.update(t,{episode:n}):Promise.reject("Error: No episode id or episode number given.")},list:function(){var t=function(e){return{id:parseInt(e.series_animedb_id,10),title:e.series_title,image:e.series_image,starts:e.series_start,ends:e.series_end,status:parseInt(e.my_status,10),currentEpisode:parseInt(e.my_watched_episodes,10),episodeCount:parseInt(e.series_episodes,10)?parseInt(e.series_episodes,10):null}},n=function(){return e.anime.list().then(function(e){return Promise.resolve(e.myanimelist.anime.map(t))})};return{get:n}}()}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=o;var i=n(9),a=r(i)},function(e,t,n){"use strict";function r(e){return o.createContextualFragment(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r;const o=document.createRange();o.setStart(document.body,0)},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}var o=n(0),i=r(o);(0,i.default)({log:!1})}]);